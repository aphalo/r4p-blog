{
  "hash": "a71718ea1c0779961d77277579c9f087",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Functional analysis of spectra with 'photobiology' to 'fda.usc'\"\nsubtitle: \"From 'photobiology' to 'fda.usc' and back.\"\nauthor: \"Pedro J. Aphalo\"\ndate: \"2023-06-02\"\ndate-modified: \"2023-07-20\"\nkeywords: [photobiology pkg, photobiologyInOut pkg, fda.usc pkg, ggspectra pkg, functional data analysis]\ncategories: [Photobiology examples]\nabstract: |\n  Explanations and example R code for applying functional data analysis to spectral data stored in the classes defined in package [photobiology](https://docs.r4photobiology.info/photobiology/) and plotting the obtained deepest curve with [ggplot2](https://ggplot2.tidyverse.org/) and [ggspectra](https://docs.r4photobiology.info/ggspectra/) and aplying ANOVA-like methods to compare groups of spectra. The excahnge of the spectral data between packages is done with functions from package [photobiologyInOut](https://docs.r4photobiology.info/photobiologyInOut/).\neditor: \n  markdown: \n    wrap: 72\ncode-fold: true\nformat:\n  html: \n    code-link: true\n    code-tools: true\n---\n\n\n::: callout-tip\nIn this page code chunks are \"folded\" so as to decrease the clutter when\nsearching for examples. Above each plot you will find a small triangle\nfollowed by \"Code\". Clicking on the triangle \"unfolds\" the code chunk\nmaking visible the R code used to produce the text or graphic output.\n\nExcept for the loading of packages shown in section **Preliminaries** code \nexamples continue through out each section.\n\nAll \"words\" defined in base R or in extension packages are linked to the\ncorresponding HTML-rendered help pages.\n\nThe code in the chunks can be copied by clicking on the top right\ncorner, where an icon appears when the mouse cursor hovers over the code\nlisting.\n:::\n\n## Introduction\n\nI have started measuring time series of spectra, and one approach to summarizing\nthem and for removing outlier curves is to use _functional data analysis_ (FDA).\nSets of spectra can be also compared using an asymptotic method reminiscent of\none-way ANOVA. Package 'fda.usc' and in particular objects of class `fdata`\nprovide a unified entry point to many different methods for FDA.\n\nPackage 'photobiologyInOut' (>= 0.4.27) exports functions `spct2fdata()`and\n`fdata2spct()` making  it easy to convert objects of classes `source_spct`,\n`response_spct`, `filter_spct` and `reflector_spct` into objects of class\n`fdata` and back.\n\nIn this page I am collecting examples of code that I have found useful. The\nexamples use `source_spct` objects, but the code can be adapted to other types\nof spectral data.\n\nIn this first version of the page I use package 'fda.usc' for all examples.\nNewer approaches are available for FANOVA, such as those implemented in package\n'fdANOVA'.\n\n## Preliminaries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(photobiology)\nlibrary(photobiologyInOut)\nlibrary(ggspectra)\nlibrary(magrittr)\nlibrary(rlang)\nlibrary(fda.usc)\nlibrary(lubridate)\n\ntheme_set(theme_bw())\n\n# energy_as_default()\nphoton_as_default()\n```\n:::\n\n\n## Deepest curve\n\nThe word \"deepest\" refers to the curve that is farthest from the extreme ones,\nbased on some criterion. The examples below are for median and mean.\n\nExamples in this chapter are for a time series of 45 spectra, measured at a frequency of one per minute close to noon on a summer day under broken clouds. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"sun.cosine.spct.Rda\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nrOmniDriver:\nEnvironment variable OOI_HOME is not set to a path.\nPlease, make sure that the OmniDriver driver is installed and that the environment variable OOI_HOME is set to its path.\n```\n\n\n:::\n\n```{.r .cell-code}\nsun.cosine.spct <- clean(sun.cosine.spct)\nwhen_measured(sun.cosine.spct)[c(1, 45)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$time.01\n[1] \"2023-05-29 09:24:00 UTC\"\n\n$time.45\n[1] \"2023-05-29 10:08:01 UTC\"\n```\n\n\n:::\n\n```{.r .cell-code}\nhow_measured(sun.cosine.spct)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Acquired with MayaPro2000 (MAYP11278), R (4.3.0), 'ooacquire' (0.3.4.9000) in mode \\\"series-attr\\\",\\n 'rOmniDriver' (0.1.19) and OmniDriver (2.71.0).\"\n```\n\n\n:::\n:::\n\n\nAs array spectrometers have a variable wavelength step between pixels, we re-express the spectra at 1 nm resolution. We also trim the shortest and longest wavelengths as these spectral irradiance values are noisy.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubset2mspct(sun.cosine.spct) %>%\n  clean() %>%\n  trim_wl(c(280, 1000)) %>%\n  interpolate_mspct(length.out = 721) -> sun.cosine.mspct\n```\n:::\n\n\n### Highlight the \"median\" spectrum\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(sun.cosine.mspct, \n         annotations = c(\"-\", \"peaks\")) +\n  geom_line(data = . %>% spct2fdata() %>% func.med.FM() %>% fdata2spct(),\n            colour = \"red\", linewidth = 1, alpha = 0.67)\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-4-1.svg)\n:::\n:::\n\n\n### Highlight the \"mean\" spectrum\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(sun.cosine.mspct, \n         annotations = c(\"-\", \"peaks\")) +\n  geom_line(data = . %>% spct2fdata() %>% func.mean() %>% fdata2spct(),\n            colour = \"blue\", linewidth = 1, alpha = 0.67)\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-5-1.svg)\n:::\n:::\n\n\n### Highlight the \"trimmed mean\" spectrum\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(sun.cosine.mspct, \n         annotations = c(\"-\", \"peaks\")) +\n  geom_line(data = . %>% spct2fdata() %>% func.trim.FM(trim = 0.25) %>% fdata2spct(),\n            colour = \"green\", linewidth = 1, alpha = 0.67)\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-6-1.svg)\n:::\n:::\n\n\n## Functional one-way ANOVA\n\nWe compare measurements done in parallel with two spectrometers with different entrance optics. Ten spectra were acquired once every 40 s inside a mixed forest next to a forest edge. A flat diffuser with cosine response and a hemispherical (or dome-shaped) diffuser with increased response at low angles of incidence are compared. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"cos.A2.2m.series.spct.Rda\")\nload(\"dome.A2.2m.series.spct.Rda\")\n```\n:::\n\n\nAs the two spectrometers even with identical configuration have slightly different wavelength calibrations for the individual pixels in the array, we need to re-express the spectra on identical wavelengths. We also trim the shortest and longest wavelengths as these spectral irradiance values are noisier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwhen_measured(cos.A2.2m.series.spct)[c(1, 10)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$time.01\n[1] \"2023-07-04 15:23:40 UTC\"\n\n$time.10\n[1] \"2023-07-04 15:29:40 UTC\"\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(how_measured(cos.A2.2m.series.spct))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAcquired with MayaPro2000 (MAYP112785), with a cosine diffuser)\nR (4.3.0), 'ooacquire' (0.4.1) in mode \"series\", 'rOmniDriver' (0.1.19.9000) and OmniDriver (2.72).\n```\n\n\n:::\n\n```{.r .cell-code}\nshade.cosine.mspct <- subset2mspct(cos.A2.2m.series.spct) %>%\n  clean() %>%\n  trim_wl(c(280, 1000)) %>%\n  interpolate_mspct(length.out = 721)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwhen_measured(dome.A2.2m.series.spct)[c(1, 10)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$time.01\n[1] \"2023-07-04 15:23:40 UTC\"\n\n$time.10\n[1] \"2023-07-04 15:29:40 UTC\"\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(how_measured(dome.A2.2m.series.spct))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAcquired with MayaPro2000 (MAYP11278), with a hemispherical diffuser)\nR (4.3.1), 'ooacquire' (0.4.1) in mode \"series\", 'rOmniDriver' (0.1.19.9000) and OmniDriver (2.72).\n```\n\n\n:::\n\n```{.r .cell-code}\nshade.dome.mspct <- subset2mspct(dome.A2.2m.series.spct) %>%\n  clean() %>%\n  trim_wl(c(280, 1000)) %>%\n  interpolate_mspct(length.out = 721)\n```\n:::\n\n\nWe concatenate the collections of spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshade.mspct <- c(cosine = shade.cosine.mspct,\n                 dome = shade.dome.mspct)\nnames(shade.mspct)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"cosine.time.01\" \"cosine.time.02\" \"cosine.time.03\" \"cosine.time.04\"\n [5] \"cosine.time.05\" \"cosine.time.06\" \"cosine.time.07\" \"cosine.time.08\"\n [9] \"cosine.time.09\" \"cosine.time.10\" \"dome.time.01\"   \"dome.time.02\"  \n[13] \"dome.time.03\"   \"dome.time.04\"   \"dome.time.05\"   \"dome.time.06\"  \n[17] \"dome.time.07\"   \"dome.time.08\"   \"dome.time.09\"   \"dome.time.10\"  \n```\n\n\n:::\n:::\n\n\nA plot of all 20 spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(shade.mspct) +\n  aes(linetype = ifelse(grepl(\"cosine\", spct.idx), \"cosine\", \"dome\")) +\n  labs(linetype = \"Entrance\\noptics\")\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-11-1.svg)\n:::\n:::\n\n\nWe test in a one-way ANOVA if the spectra differ, and they do differ significantly.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshade.fda <- mspct2fdata(shade.mspct)\nshade.anova <-\n  fanova.onefactor(shade.fda,\n                   group = factor(rep(c(\"cosine\", \"dome\"), each = 10L)),\n                   plot = TRUE)\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-12-1.svg)\n:::\n\n```{.r .cell-code}\nshade.anova$pvalue\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\nTo test if the shape of the spectra differs, we first scale them to equal area under the curve, and repeat the ANOVA analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshade_scaled.fda <- \n  mspct2fdata(fscale(shade.mspct, f = irrad))\nshade_scaled.anova <-\n  fanova.onefactor(shade_scaled.fda,\n                   group = factor(rep(c(\"cosine\", \"dome\"), each = 10L)),\n                   plot = TRUE)\n```\n\n::: {.cell-output-display}\n![](functional-data-analysis_files/figure-html/unnamed-chunk-13-1.svg)\n:::\n\n```{.r .cell-code}\nshade_scaled.anova$pvalue\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n## References\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncitation('fda.usc')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTo cite fda.usc in publications use:\n\n  Manuel Febrero-Bande, Manuel Oviedo de la Fuente (2012). Statistical\n  Computing in Functional Data Analysis: The R Package fda.usc. Journal\n  of Statistical Software, 51(4), 1-28. URL\n  https://www.jstatsoft.org/v51/i04/.\n\nA BibTeX entry for LaTeX users is\n\n  @Article{,\n    title = {Statistical Computing in Functional Data Analysis: The {R} Package {fda.usc}},\n    author = {Manuel Febrero-Bande and Manuel {Oviedo de la Fuente}},\n    journal = {Journal of Statistical Software},\n    year = {2012},\n    volume = {51},\n    number = {4},\n    pages = {1--28},\n    url = {https://www.jstatsoft.org/v51/i04/},\n  }\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncitation('photobiology')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTo cite package ‘photobiology’ in publications use:\n\n  Aphalo, Pedro J. (2015) The r4photobiology suite. UV4Plants Bulletin,\n  2015:1, 21-29. DOI:10.19232/uv4pb.2015.1.14\n\nA BibTeX entry for LaTeX users is\n\n  @Article{,\n    author = {Pedro J. Aphalo},\n    title = {The r4photobiology suite},\n    journal = {UV4Plants Bulletin},\n    volume = {2015},\n    number = {1},\n    pages = {21-29},\n    year = {2015},\n    doi = {10.19232/uv4pb.2015.1.14},\n  }\n```\n\n\n:::\n:::\n",
    "supporting": [
      "functional-data-analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}