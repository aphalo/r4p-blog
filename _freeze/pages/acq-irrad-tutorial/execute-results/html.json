{
  "hash": "4d2a90632783e78a705bd4b80c99c2e2",
  "result": {
    "markdown": "---\ntitle: \"Spectral Irradiance with 'ooacquire'\"\nsubtitle: \"A Brief Tutorial (PARTIAL DRAFT)\"\nauthor: \"Pedro J. Aphalo\"\ndate: 2023-04-27\ndate-modified: 2023-04-29\ncategories: [R Package Update]\nkeywords: [ooacquire pkg]\ncode-fold: false\n---\n\n\n::: callout-note\n\nPackage 'ooacquire' is part of the [R for Photobiology suite of R\npackages](r4p-introduction.qmd) and its [full\ndocumentation](https://docs.r4photobiology.info/ooacquire) is available\non-line. It depends on package 'rOmniDriver', whose [full\ndocumentation](https://docs.r4photobiology.info/rOmniDriver) is also\navailable on-line.\n\n:::\n\n::: callout-warning\n\nThe description and diagrams shown in this page are valid for 'ooacquire'\nversion 0.3.2-1. Versions <= 0.3.2 differ from version 0.3.2-1 in the\nuser interface implemented in function `acq_irrad_interactive()` described in\nthis page.\n\n:::\n\n## Introduction\n\nR package ['ooacquire'](https://docs.r4photobiology.info/ooacquire/) is a\ncomponent of the [R for\nPhotobiology](https://www.r4photobiology.info/pages/r4p-introduction.html) suite\nof packages and supports the near-real-time acquisition of spectral data using\nOcean Optics spectrometers from [Ocean Insight](https://www.oceaninsight.com/). \nPackage 'ooacquire' imports and uses classes, methods and functions defined in other\npackages of the suite.\n\nFunction `acq_irrad_interactive()` implements the interactive acquisition of\nspectral irradiance data using Ocean Optics array spectrometers. It returns the\nacquired data as a _side effect_ by saving them to files on disk. The raw-counts\ndata are acquired and converted into spectral irradiance values. The data for\neach measurement event are saved as soon as acquired, but a group of\nsuccessively acquired spectra can be collected into a single object, summarized\nand/or saved to a file on disk in addition to the individual files per\nmeasurement event. In every case the raw counts data, instrument descriptor,\ninstrument settings and either computed spectral irradiance or computed counts\nper second are saved to disk. Plots are displayed on the screen for each\nmeasurement event. A measurement event consists of either a single light\nspectrum or of a time series of light spectra.\n\nPackage 'ooacquire' has been evolving for several years and will continue to\nevolve, specially with respect to interactive acquisition of spectral data. The\nuser interface for spectral irradiance is currently more polished and complex\nthan the interfaces for fluence spectra and transmittance and reflectance\nspectra. This is because both myself and other users most of the time use\n'ooacquire' to measure spectral irradiance.\n\nThe user interfaces (UIs) implemented in functions `acq_irrad_interactive()`,\n`acq_fluence_interactive()`, `acq_fraction_interactive()` and their variations\nare text based rather than graphical. The design is optimized for frequent users\nrather than for occasional users. A key design objective has been to make the\nacquisition of multiple spectra per measurement session as comfortable and as\nfast as possible, i.e., avoid tedious. This is different to what is usually\nmeant by _user friendly_ involving hand-holding and verbose options within the\ninterface.\n\nAs much as possible, options are selected by typing a single character, or even\njust the enter key, thanks to context and state dependent defaults. The\ninterface is as far as it can be from visually attractive, but it works well for\nmyself, and most other people who use it.\n\nTo start a session within R for the measurement of spectral irradiance\naccepting all defaults we can type at the R console, one statement to\nload and attach package 'ooacquire', a second, optional statement to set an\noption to tell R to print warning immediately instead of delayed, and a\nthird statement to call the function and then use the UI it opens.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ooacquire)\noptions(warn = 1)\nacq_irrad_interactive()\n```\n:::\n\n\nThe video below demostrates the use of the interface for an old version of\n'ooacquire' (will be replaced by an up-to-date one).\n\n\n{{< video https://vimeo.com/821595528 >}}\n\n\n\nThe UI implemented in `acq_irrad_interactive()` is rather _terse_ and, thus,\nneeds to be clearly documented. The vignettes of package 'ooacquire' include\nsome examples. However, a description of the logic can be best done using\ndiagrams. [Mermaid](https://mermaid.js.org/) is a markdown-like language for the\neasy creation of diagrams, but not yet supported in vignettes. As its many\ndiagrams are encoded using Mermaid and it includes video content, this tutorial\nis published as a page at the [R for Photobioly web\nsite](https://www.r4photobiology.info) instead of as part of the 'ooacquire'\nR pakage documentation.\n\n## Interface modes\n\nFunction `acq_irrad_interactive()` is like a Swiss Army Knife. It has multiple\n''personalities'' and the first step is the choice of `interface.mode`, which\ndetermines which interface will be shown to the user. Basically, the selected\n`interface.mode` determines which options can be modified by the user through\nthe interactive UI and which ones are fixed at the values set when the function\nis called. \n\nIn addition, whether PDF files containing plots of individual measurements, and\nwhether different summaries and plots from the created collectiond of spectra\nare saved to files or not can be controlled also by passing arguments to formal\nparameters when the function is called.\n\nNormally, when measuring several spectra in a row, any redundant need to select\nchoices in a menue or enter repeatedly the same setting values by the user is\ndistracting and time consuming. This is tackled using three three strategies: 1)\nwith multiple interface modes with each mode displaying the parts of the user\ninterface used in the case of a given type of measurements, and 2) by\ncontext-dependent defaults in menues, and 3) by easily repeating measurements\nwith the most recently used settings and reference readings.\n\nIn this section we describe the overall logic behind strategies 1) and 3). Four\nmodes are available, and which one is used is selected by the argument passed to\nformal parameter `interface.mode` when `acq_irrad_interactive()` is called to\nstart a spectral-data acquisition session.\nThere are four main interface modes built into `acq_irrad_interactive()` with \n`\"auto\"` as default.\n\n\n```{mermaid}\n%%{ init: {\"graph\": {\"htmlLabels\": true}} }%%\n%%| fig-align: center\nflowchart TB\n  A[interface.mode = ] -.-> B(\"simple\")\n  A --> C(<b>auto</b>)\n  A -.-> D(\"series\")\n  A -.-> E(\"full\")\n```\n\n\nAppending `-attr` to these mode names enables the UI for setting the values of \nattributes `what.measured` and `comment`. For example, `\"simple\"` becomes\n`\"simple-attr\"`.\n\n## Start up\n\nThe UI does not differ among interface modes for the initialization steps, and\nit is not part of the loop for the acquisition of individual spectra or series\nof spectra.\n\n\n```{mermaid}\n%%| fig-align: center\nflowchart TB\n  A((<b>start</b>)) --> B(select spectrometer\\nand channel?)\n  B --> C(session name?) --> C1(user name?) --> D(folder name?) --> E(((<b>1</b>)))\n```\n\n\nThe loop diagrams shown in the sections below, are all active after these first \nsteps are completed. The encircled 1, simply signals this connection.\n\n## User Interface Loop\n\nIn the diagrams below I show single boxes not only for the input of single values but also for\nmenus containing multiple options. These menues are `attribute?`, `acquisition parameters?`, \nand `series parameters?`. Within `plot and save` and `plot and save collection`\nthere are options about the formatting of the plot, and in the second case also\nabout the file name used to save the collection.\n\nWe start with a complete flowchart of the UI loop for the acquisition of \nspectra, which shows all the possibilities, but does not correspond to any\n`interface.mode`, because all of them are subsets.\n\nOnce one measurement is completed and saved, a new measurement can be acquire\nusing the same settings for the acquisition as well as reusing the same _dark_ and\n_filter_ reference spectra (`repeat`) or with the possibility of changing\nthese settings and acquiring fresh _dark_ and _filter_ reference spectra (`next`).\n\n\n```{mermaid}\n%%| fig-align: center\nflowchart TB\n  E(((<b>1</b>))) --> G(protocol?)\n  G --> I(object name?) --> J(attributes?) --> K(acquisition\\nparameters?)\n  K --> L(series parameters?) --> M[[measure\\nspectra]] --> N[(plot and save)] \n  N --> N1{collect?} --yes--> N2[(plot and save\\ncollection)] --> O{next\\n repeat\\n or end?}\n  N1 --no--> O\n  I -.repeat.-> L\n  O -.repeat.-> I\n  O --next--> G\n  O --> P((<b>end</b>))\n```\n\n\n### `\"simple\"` mode\n\nThe `\"simple\"` interface mode provides a minimalist UI, quite similar to the only UI available\nin early versions of 'ooacquire'. It is intended for the acquisition of individual spectra.\n\n\n```{mermaid}\n%%| fig-align: center\n%%{ init: {\"graph\": {\"htmlLabels\": true}} }%%\nflowchart\n  E(((<b>1</b>))) --> G(protocol?)\n  G --> I(object name?) --> K(acquisition\\nparameters?\\n<i>simplified</i>)\n  K --> M[[measure\\nspectra]] --> N[(plot and save)] --> O{next\\nrepeat\\nor end?}\n  I -.repeat.-> M\n  O -.repeat.-> I\n  O --next--> G\n  O --> P((<b>end</b>))\n```\n\n\n### `\"auto\"` mode\n\nThe `\"auto\"` interface mode provides a complete UI intended for the acquisition of individual spectra and possibly packing groups of spectra into collections.\n\n\n```{mermaid}\n%%| fig-align: center\n%%{ init: {\"graph\": {\"htmlLabels\": true}} }%%\nflowchart TB\n  E(((<b>1</b>))) --> G(protocol?)\n  G --> I(object name?) --> K(acquisition\\nparameters?\\n<i>full</i>)\n  K --> M[[measure\\nspectra]] --> N[(plot and save)]\n  N --> N1{collect?} --yes--> N2[(plot and save\\ncollection)] --> O{next\\nrepeat\\nor end?}\n  N1 --no--> O\n  I -.repeat.-> M\n  O -.repeat.-> I\n  O --next--> G\n  O --> P((<b>end</b>))\n```\n\n\n### `\"series\"` mode\n\nThe `\"series\"` interface mode provides a complete UI intended for the acquisition of time series of spectra and possibly packing groups of time series of spectra into collections.\n\n\n```{mermaid}\n%%| fig-align: center\n%%{ init: {\"graph\": {\"htmlLabels\": true}} }%%\nflowchart TB\n  E(((<b>1</b>))) --> G(protocol?)\n  G --> I(object name?) --> K(acquisition\\nparameters?\\n<i>full</i>)\n  K --> L(series parameters?) --> M[[measure\\nspectra]] --> N[(plot and save)]\n  N --> N1{collect?} --yes--> N2[(plot and save\\ncollection)] --> O{next\\nrepeat\\nor end?}\n  N1 --no--> O\n  I -.repeat.-> L\n  O -.repeat.-> I\n  O --next--> G\n  O --> P((<b>end</b>))\n```\n\n\n### `\"-attr\"` variants of the  modes\n\nAppending `\"-attr\"` to the name of any `interface-mode` enables the menue\nand dialogues that enable the setting of the `what.measured` and `comment`\nattributes of the `source_spct` objects into which spectra are saved. This\ncan be represented in the diagrams by the insertion of the `attributes?` box \nbetween `object name?` and `acquistion parameters?` as shown in the first\ndiagram showing the full logic. \n\n### Selecting the interface mode\n\nWhen calling function `acq_irrad_interactive()` we can pass arguments to\ntailor the UI to our current needs. \nFor example, to use the `\"simple\"` mode instead of the default `\"auto\"` mode\nwe can call the function as follows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacq_irrad_interactive(interface.mode = \"simple\")\n```\n:::\n\n\nWe can in addition disable the saving of specific output to files. For example\nto disable the saving of PDF files of the plots from individual measurements and\nfrom collections of spectra we can use:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacq_irrad_interactive(save.pdfs = FALSE)\n```\n:::\n\n\nIf we do not intend to create and save collections of spectra or summaries, we can\ndisable these steps, removing from users' view one menu that becomes redundant.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacq_irrad_interactive(save.collections = FALSE, \n                      save.summaries = FALSE)\n```\n:::\n\n\nIf we do not want to save ready made summaries but still be able to create\nand save collections of spectra we can use.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacq_irrad_interactive(save.summaries = FALSE)\n```\n:::\n\n\nOf course, these options are independent of each other, and can be combined as \nneeded.\n\n::: callout-note\nSaving plots of large collections of spectra or of long time series of spectra \nto disk is a slow process. Disabling this step can be worthwhile in such cases.\n:::\n\n## Measurement protocols\n\nThe different diagrams below _open_ the actions that take place within the\n`measure spectra` boxes in the diagrams above, previously treated as _black\nboxes_. These actions depend on the protocol used for the measurements and on\nwhether the measurement is a fresh one (`next`) or one reusing settings and\nreference measurements (`repeat`). The same measurement protocols are available\nin the different user interface modes. We show here the protocols available by\ndefault. However, users can define their own protocols. In the diagrams below,\n`start` and `end` represent the start and end of a measurement event, i.e., the\nboundaries of the generic `measure spectra` boxes in the diagrams above.\n\n### Protocol `l`\n\n`l` stands for acquisition of _light_ scans.\n\n\n```{mermaid}\nflowchart LR\n  S((<b>start</b>)) --> C\n  C[light\\nspectrum or\\nspectra] --> E((<b>end</b>))\n```\n\n\n### Protocol `ld`\n\n`ld` stands for acquisition of _light_ and _dark_ scans sequentially in this order.\n\n\n```{mermaid}\nflowchart LR\n  S((<b>start</b>)) --> A\n  A -.repeat.-> E\n  A[light\\nspectrum or\\nspectra] --next--> D[dark\\nspectrum] --> E((<b>end</b>))\n```\n\n\n### Protocol `lfd`\n\n`lfd` stands for acquisition of _light_, _filter_ and _dark_ scans sequentially in this order.\n\n\n```{mermaid}\nflowchart LR\n  S((<b>start</b>)) --> A\n  A -.repeat.-> E\n  A[light\\nspectrum or\\nspectra] --next--> B[filter\\nspectrum] --> C[dark\\nspectrum] --> E((<b>end</b>))\n```\n\n\n### Protocol `dl`\n\n`dl` is identical to `ld` except for the sequential order of the acquisition of data.\n\n\n```{mermaid}\nflowchart LR\n  S((<b>start</b>)) --next--> A\n  S -.repeat.-> C\n  A[dark\\nspectrum] --> C[light\\nspectrum or\\nspectra] --> E((<b>end</b>))\n```\n\n\n### Protocol `dfl`\n\n`dfl` is identical to `lfd` except for the sequential order of the acquisition of data.\n\n\n```{mermaid}\nflowchart LR\n  S((<b>start</b>)) --next--> A\n  S -.repeat.-> C\n  A[dark\\nspectrum] --> B[filter\\nspectrum] --> C[light\\nspectrum or\\nspectra] --> E((<b>end</b>))\n```\n\n\n## Acquisition parameters\n\nWe describe the data acquisition parameters only briefly here, and refer the\nreader to the [vignette that describes the algorithms\nused](https://docs.r4photobiology.info/ooacquire/articles/userguide-algorithms.html)\nincluded in package 'ooacquire'.\n\nFor the _integration time_ used for the acquisition of data a distinction is made\nbetween the duration of a single integration event and the total added-up\nintegration time resulting from successive integrations averaged by the\nspectrometer or driver. The duration of individual integrations needs to be\nadjusted or tuned so that full use is made of the dynamic range and signal to\nnoise headroom of the instrument. The total measured time, can obviously be\nonly as long or longer than a single integration. When spectral irradiance \nis constant in time, the longer the total time over which scans are averaged\nthe better \"random\" noise is controlled.\n\nTo increase the dynamic range we can use different integration times for\ndifferent wavelength-regions of the spectrum (HDR or \"bracketing\") and splice the\ncounts per second spectra during their conversion into spectral irradiance.\nDynamic range is not the only limiting factor. Stray light and thermal noise\nlimit the signal to noise ratio. Stray light may depend on the shape of the\nmeasured spectrum and thermal noise on the temperature of the spectrometer.\nIn normal cases the achievable increase in dynamic range with the HDR approach \nis approxinately one order of magnitude.\n\nStray light can be most effectively corrected for by measuring it separately\nfrom the target of the measurements. This is the role of the filter\nmeasurements in the protocols described above.\n\nAcquisition parameters include the integration time (= duration of a single\nintegration) which is normally, but not always, adjusted by automatic tuning\n(i.e., by trial and error, taking into account a target margin of headroom\nsupplied by the user), and a target duration range for the sum of multiple\nintegration times desired, which is always explicitly supplied by the user. For\nbracketing the user supplies a vector of multipliers to be applied to the\noptimal or set integration time. All parameters have defaults, and user-entered\nvalues persist between successive measurement events unless modified again by\nthe user.\n\n::: callout-note\n\nFor additional information, please, see the [help page for\n`acq_irrad_interactive()`](https://docs.r4photobiology.info/ooacquire/reference/acq_irrad_interactive.html)\nand the vignetters of package 'ooacquire', especially that [describing the\nalgorithms\nused](https://docs.r4photobiology.info/ooacquire/articles/userguide-algorithms.html).\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}